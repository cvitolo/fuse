<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>fuse: Framework for Understanding Structural Errors • fuse</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="fuse: Framework for Understanding Structural Errors">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fuse</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">3.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="http://dx.doi.org/10.21105/joss.00052">JOSS paper</a>
    </li>
    <li>
      <a href="../articles/index.html">Vignette</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cvitolo/fuse/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>fuse: Framework for Understanding Structural Errors</h1>
                        <h4 class="author">Claudia Vitolo</h4>
            
            <h4 class="date">2018-08-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cvitolo/fuse/blob/master/vignettes/fuse_vignette.Rmd"><code>vignettes/fuse_vignette.Rmd</code></a></small>
      <div class="hidden name"><code>fuse_vignette.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The fuse modelling framework takes as input rainfall and potential evapotranspiration time series (areal averages over the river catchment area) and returns a simulated time series of river discharges. It can be used to understand the variability of expected hydrological responses based on model structures.</p>
<p>This package is an implementation of the framework for hydrological modelling FUSE described in Clark et al. (2008) and based on the Fortran code provided by M. Clark in 2011. The package consists of two modules: Soil Moisture Accounting module (fusesma.sim) and Gamma routing module (fuserouting.sim). It also contains default parameter ranges (fusesma.ranges and fuserouting.ranges) and three data objects: fuse_hydrological_timeseries (sample input dataset), parameters (sample parameters) and modlist (list of FUSE model structures).</p>
<div id="dependencies" class="section level3">
<h3 class="hasAnchor">
<a href="#dependencies" class="anchor"></a>Dependencies</h3>
<p>The fuse package, as well as the examples in this vignette, depend on a number of CRAN packages. Check for missing dependencies and install them:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">packs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"dplyr"</span>, <span class="st">"zoo"</span>, <span class="st">"tgp"</span>, <span class="st">"stats"</span>, <span class="st">"utils"</span>, <span class="st">"BH"</span>, <span class="st">"Rcpp"</span>, <span class="st">"testthat"</span>,</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">           <span class="st">"qualV"</span>, <span class="st">"devtools"</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">new.packages &lt;-<span class="st"> </span>packs[<span class="op">!</span>(packs <span class="op">%in%</span><span class="st"> </span><span class="kw">installed.packages</span>()[, <span class="st">"Package"</span>])]</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="cf">if</span>(<span class="kw">length</span>(new.packages)) {</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="kw">install.packages</span>(new.packages, <span class="dt">repos =</span> <span class="st">"https://cran.ma.imperial.ac.uk/"</span>)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">}</a></code></pre></div>
</div>
<div id="installation" class="section level3">
<h3 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h3>
<p>You can install this package from Github with <a href="https://github.com/hadley/devtools">devtools</a>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"cvitolo/fuse"</span>)</a></code></pre></div>
<p>Load the fuse package:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(<span class="st">"fuse"</span>)</a></code></pre></div>
</div>
<div id="data-and-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#data-and-parameters" class="anchor"></a>Data and parameters</h3>
<p>Load sample data (daily time step)</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">data</span>(fuse_hydrological_timeseries)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">myDELTIM &lt;-<span class="st"> </span><span class="dv">1</span></a></code></pre></div>
<p>Define parameter ranges</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">DefaultRanges &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">t</span>(<span class="kw">data.frame</span>(<span class="kw">c</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/fuse/topics/fusesma.ranges">fusesma.ranges</a></span>(),</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">                                           <span class="kw"><a href="http://www.rdocumentation.org/packages/fuse/topics/fuserouting.ranges">fuserouting.ranges</a></span>()))))</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">names</span>(DefaultRanges) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"Min"</span>, <span class="st">"Max"</span>)</a></code></pre></div>
<p>Sample parameter set using Latin Hypercube method</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">numberOfRuns &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">parameters &lt;-<span class="st"> </span>tgp<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tgp/topics/lhs">lhs</a></span>( numberOfRuns, <span class="kw">as.matrix</span>(DefaultRanges) )</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">parameters &lt;-<span class="st"> </span><span class="kw">data.frame</span>(parameters)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw">names</span>(parameters) &lt;-<span class="st"> </span><span class="kw">row.names</span>(DefaultRanges)</a></code></pre></div>
<p>Alternatively, sample parameter set using built-in function</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">parameters &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fuse/topics/generateParameters">generateParameters</a></span>(<span class="dv">100</span>)</a></code></pre></div>
</div>
<div id="example-usage-with-1-model-structure" class="section level3">
<h3 class="hasAnchor">
<a href="#example-usage-with-1-model-structure" class="anchor"></a>Example usage with 1 model structure</h3>
<p>Define the model to use, e.g. TOPMODEL (MID = 60)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">myMID &lt;-<span class="st"> </span><span class="dv">60</span></a></code></pre></div>
<p>Use the built-in function to run FUSE for the 1st sampled parameter set</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">streamflow &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fuse/topics/fuse">fuse</a></span>(fuse_hydrological_timeseries, myMID, myDELTIM, parameters[<span class="dv">1</span>,])</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">plot</span>(streamflow, <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> <span class="st">"Streamflow [mm/day]"</span>)</a></code></pre></div>
<p><img src="fuse_vignette_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>Run FUSE for all the sampled parameter sets</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">plot</span>(fuse_hydrological_timeseries<span class="op">$</span>Q, <span class="dt">type =</span> <span class="st">"l"</span>, </a>
<a class="sourceLine" id="cb10-2" data-line-number="2">     <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> <span class="st">"Streamflow [mm/day]"</span>)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">dim</span>(parameters)[<span class="dv">1</span>]){</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  <span class="kw">lines</span>(zoo<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/zoo/topics/zoo">zoo</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/fuse/topics/fuse">fuse</a></span>(<span class="dt">DATA =</span> fuse_hydrological_timeseries, </a>
<a class="sourceLine" id="cb10-7" data-line-number="7">                      <span class="dt">mid =</span> myMID, </a>
<a class="sourceLine" id="cb10-8" data-line-number="8">                      <span class="dt">deltim =</span> myDELTIM, </a>
<a class="sourceLine" id="cb10-9" data-line-number="9">                      <span class="dt">ParameterSet =</span> parameters[i,]), </a>
<a class="sourceLine" id="cb10-10" data-line-number="10">                 <span class="dt">order.by =</span> zoo<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/zoo/topics/index">index</a></span>(fuse_hydrological_timeseries)),</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">        <span class="dt">col =</span> <span class="st">"gray"</span>, <span class="dt">lwd =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  </a>
<a class="sourceLine" id="cb10-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="kw">lines</span>(fuse_hydrological_timeseries<span class="op">$</span>Q, <span class="dt">col =</span> <span class="st">"black"</span>)</a></code></pre></div>
<p><img src="fuse_vignette_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
</div>
<div id="ensemble-modelling" class="section level3">
<h3 class="hasAnchor">
<a href="#ensemble-modelling" class="anchor"></a>Ensemble modelling</h3>
<p>Define a group of model structures to use</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">mids &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">60</span>, <span class="dv">230</span>, <span class="dv">342</span>, <span class="dv">426</span>)</a></code></pre></div>
<p>Run a multi-model calibration using the Nash-Sutcliffe efficiency as objective function</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">indices &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, <span class="dv">4</span><span class="op">*</span><span class="kw">dim</span>(parameters)[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">discharges &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">ncol =</span> <span class="dv">4</span><span class="op">*</span><span class="kw">dim</span>(parameters)[<span class="dv">1</span>], <span class="dt">nrow =</span> <span class="kw">dim</span>(fuse_hydrological_timeseries)[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">kCounter &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>){</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">  myMID &lt;-<span class="st"> </span>mids[m]</a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">  <span class="cf">for</span> (pid <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">dim</span>(parameters)[<span class="dv">1</span>]){</a>
<a class="sourceLine" id="cb12-10" data-line-number="10"></a>
<a class="sourceLine" id="cb12-11" data-line-number="11">    kCounter &lt;-<span class="st"> </span>kCounter <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12">    </a>
<a class="sourceLine" id="cb12-13" data-line-number="13">    Qrout &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/fuse/topics/fuse">fuse</a></span>(<span class="dt">DATA =</span> fuse_hydrological_timeseries, </a>
<a class="sourceLine" id="cb12-14" data-line-number="14">                  <span class="dt">mid =</span> myMID, </a>
<a class="sourceLine" id="cb12-15" data-line-number="15">                  <span class="dt">deltim =</span> myDELTIM, </a>
<a class="sourceLine" id="cb12-16" data-line-number="16">                  <span class="dt">ParameterSet =</span> parameters[pid, ])</a>
<a class="sourceLine" id="cb12-17" data-line-number="17"> </a>
<a class="sourceLine" id="cb12-18" data-line-number="18">    indices[kCounter] &lt;-<span class="st"> </span>qualV<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/qualV/topics/EF">EF</a></span>(fuse_hydrological_timeseries<span class="op">$</span>Q, Qrout)  </a>
<a class="sourceLine" id="cb12-19" data-line-number="19">    discharges[, kCounter] &lt;-<span class="st"> </span>Qrout</a>
<a class="sourceLine" id="cb12-20" data-line-number="20">    </a>
<a class="sourceLine" id="cb12-21" data-line-number="21">    }</a>
<a class="sourceLine" id="cb12-22" data-line-number="22">}</a></code></pre></div>
<p>Compare results</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">bestRun &lt;-<span class="st"> </span><span class="kw">which</span>(indices <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(indices))</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">numberOfRuns &lt;-<span class="st"> </span><span class="kw">dim</span>(parameters)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">bestModel &lt;-<span class="st"> </span><span class="cf">function</span>(runNumber){</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  <span class="cf">if</span> (runNumber <span class="op">&lt;</span><span class="st"> </span>(numberOfRuns <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)) myBestModel &lt;-<span class="st"> "TOPMODEL"</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb13-8" data-line-number="8">  <span class="cf">if</span> (runNumber <span class="op">&gt;</span><span class="st"> </span>(numberOfRuns <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="st">      </span>runNumber <span class="op">&lt;</span><span class="st"> </span>(<span class="dv">2</span><span class="op">*</span>numberOfRuns <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)) myBestModel &lt;-<span class="st"> "ARNOXVIC"</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb13-11" data-line-number="11">  <span class="cf">if</span> (runNumber <span class="op">&gt;</span><span class="st"> </span>(<span class="dv">2</span><span class="op">*</span>numberOfRuns <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="st">      </span>runNumber <span class="op">&lt;</span><span class="st"> </span>(<span class="dv">3</span><span class="op">*</span>numberOfRuns <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)) myBestModel &lt;-<span class="st"> "PRMS"</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb13-14" data-line-number="14">  <span class="cf">if</span> (runNumber <span class="op">&gt;</span><span class="st"> </span>(<span class="dv">3</span><span class="op">*</span>numberOfRuns <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="st">      </span>runNumber <span class="op">&lt;</span><span class="st"> </span>(<span class="dv">4</span><span class="op">*</span>numberOfRuns <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)) myBestModel &lt;-<span class="st"> "SACRAMENTO"</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">  </a>
<a class="sourceLine" id="cb13-17" data-line-number="17">  <span class="kw">return</span>(myBestModel)</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">  </a>
<a class="sourceLine" id="cb13-19" data-line-number="19">}</a>
<a class="sourceLine" id="cb13-20" data-line-number="20"></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="kw">bestModel</span>(bestRun)</a>
<a class="sourceLine" id="cb13-22" data-line-number="22"><span class="co">#&gt; [1] "SACRAMENTO"</span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23"> </a>
<a class="sourceLine" id="cb13-24" data-line-number="24"><span class="kw">plot</span>(zoo<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/zoo/topics/coredata">coredata</a></span>(fuse_hydrological_timeseries<span class="op">$</span>Q), <span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">lwd=</span><span class="fl">0.5</span>, </a>
<a class="sourceLine" id="cb13-25" data-line-number="25">     <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> <span class="st">"Streamflow [mm/day]"</span>)</a>
<a class="sourceLine" id="cb13-26" data-line-number="26"> </a>
<a class="sourceLine" id="cb13-27" data-line-number="27"><span class="cf">for</span>(pid <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(<span class="dv">4</span><span class="op">*</span>numberOfRuns)){</a>
<a class="sourceLine" id="cb13-28" data-line-number="28">  </a>
<a class="sourceLine" id="cb13-29" data-line-number="29"> <span class="kw">lines</span>(discharges[, pid], <span class="dt">col =</span> <span class="st">"gray"</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb13-30" data-line-number="30">  </a>
<a class="sourceLine" id="cb13-31" data-line-number="31">}</a>
<a class="sourceLine" id="cb13-32" data-line-number="32"> </a>
<a class="sourceLine" id="cb13-33" data-line-number="33"><span class="kw">lines</span>(zoo<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/zoo/topics/coredata">coredata</a></span>(fuse_hydrological_timeseries<span class="op">$</span>Q), <span class="dt">col =</span> <span class="st">"black"</span>, <span class="dt">lwd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb13-34" data-line-number="34"><span class="kw">lines</span>(discharges[, bestRun], <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">lwd =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="fuse_vignette_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<p>How the best simulation of each model structure compare to each other?</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">bestRun0060 &lt;-<span class="st"> </span><span class="kw">which</span>(indices[<span class="dv">1</span><span class="op">:</span>numberOfRuns] <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(indices[<span class="dv">1</span><span class="op">:</span>numberOfRuns]))</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">bestRun0230 &lt;-<span class="st"> </span>numberOfRuns <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">  </span><span class="kw">which</span>(indices[(numberOfRuns<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(<span class="dv">2</span><span class="op">*</span>numberOfRuns)] <span class="op">==</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">          </span><span class="kw">max</span>(indices[(numberOfRuns<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(<span class="dv">2</span><span class="op">*</span>numberOfRuns)]))</a>
<a class="sourceLine" id="cb14-6" data-line-number="6"></a>
<a class="sourceLine" id="cb14-7" data-line-number="7">bestRun0342 &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">*</span>numberOfRuns <span class="op">+</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="st">  </span><span class="kw">which</span>(indices[(<span class="dv">2</span><span class="op">*</span>numberOfRuns<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(<span class="dv">3</span><span class="op">*</span>numberOfRuns)] <span class="op">==</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="st">          </span><span class="kw">max</span>(indices[(<span class="dv">2</span><span class="op">*</span>numberOfRuns<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(<span class="dv">3</span><span class="op">*</span>numberOfRuns)]))</a>
<a class="sourceLine" id="cb14-10" data-line-number="10"></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">bestRun0426 &lt;-<span class="st"> </span><span class="dv">3</span><span class="op">*</span>numberOfRuns <span class="op">+</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="st">  </span><span class="kw">which</span>(indices[(<span class="dv">3</span><span class="op">*</span>numberOfRuns<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(<span class="dv">4</span><span class="op">*</span>numberOfRuns)] <span class="op">==</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="st">          </span><span class="kw">max</span>(indices[(<span class="dv">3</span><span class="op">*</span>numberOfRuns<span class="op">+</span><span class="dv">1</span>)<span class="op">:</span>(<span class="dv">4</span><span class="op">*</span>numberOfRuns)]))</a>
<a class="sourceLine" id="cb14-14" data-line-number="14"></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="kw">plot</span>(zoo<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/zoo/topics/coredata">coredata</a></span>(fuse_hydrological_timeseries<span class="op">$</span>Q), <span class="dt">type =</span> <span class="st">"l"</span>, <span class="dt">lwd=</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb14-16" data-line-number="16">     <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> <span class="st">"Streamflow [mm/day]"</span>)</a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="kw">lines</span>(discharges[, bestRun0060], <span class="dt">col =</span> <span class="st">"green"</span>, <span class="dt">lwd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="kw">lines</span>(discharges[, bestRun0230], <span class="dt">col =</span> <span class="st">"blue"</span>, <span class="dt">lwd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="kw">lines</span>(discharges[, bestRun0342], <span class="dt">col =</span> <span class="st">"pink"</span>, <span class="dt">lwd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="kw">lines</span>(discharges[, bestRun0426], <span class="dt">col =</span> <span class="st">"orange"</span>, <span class="dt">lwd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-21" data-line-number="21"> </a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="kw">legend</span>(<span class="st">"top"</span>, </a>
<a class="sourceLine" id="cb14-23" data-line-number="23">        <span class="kw">c</span>(<span class="st">"TOPMODEL"</span>, <span class="st">"ARNOXVIC"</span>, <span class="st">"PRMS"</span>,<span class="st">"SACRAMENTO"</span>), </a>
<a class="sourceLine" id="cb14-24" data-line-number="24">        <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">"green"</span>, <span class="st">"blue"</span>, <span class="st">"pink"</span>, <span class="st">"orange"</span>),</a>
<a class="sourceLine" id="cb14-25" data-line-number="25">        <span class="dt">lty =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</a></code></pre></div>
<p><img src="fuse_vignette_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
</div>
</div>
<div id="use-fuse-with-hydromad" class="section level1">
<h1 class="hasAnchor">
<a href="#use-fuse-with-hydromad" class="anchor"></a>Use fuse with hydromad</h1>
<p><a href="http://hydromad.catchment.org/">Hydromad</a> is an excellent framework for hydrological modelling, optimization, sensitivity analysis and assessment of results. It contains a large set of soil moisture accounting modules and routing functions. Thanks to Joseph Guillaume (hydromad’s maintainer), fuse is now compatible with hydromad and below are some examples Joseph provided to use fuse within the hydromad environment.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># Install and load hydromad</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw">install.packages</span>(<span class="kw">c</span>(<span class="st">"zoo"</span>, <span class="st">"latticeExtra"</span>, <span class="st">"polynom"</span>, <span class="st">"car"</span>, </a>
<a class="sourceLine" id="cb15-3" data-line-number="3">                   <span class="st">"Hmisc"</span>, <span class="st">"reshape"</span>, <span class="st">"DEoptim"</span>, <span class="st">"coda"</span>))</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="kw">install.packages</span>(<span class="st">"dream"</span>, <span class="dt">repos=</span><span class="st">"http://hydromad.catchment.org"</span>)</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="kw">install.packages</span>(<span class="st">"hydromad"</span>, <span class="dt">repos=</span><span class="st">"http://hydromad.catchment.org"</span>)</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="kw">library</span>(hydromad) </a>
<a class="sourceLine" id="cb15-7" data-line-number="7"></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co"># Load fuse and an example dataset</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="kw">library</span>(fuse)</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="kw">data</span>(fuse_hydrological_timeseries)</a>
<a class="sourceLine" id="cb15-11" data-line-number="11"></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co"># Set the parameter ranges using hydromad.options</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="kw">hydromad.options</span>(<span class="dt">fusesma =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/fuse/topics/fusesma.ranges">fusesma.ranges</a></span>(),</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">                 <span class="dt">fuserouting =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/fuse/topics/fuserouting.ranges">fuserouting.ranges</a></span>())</a>
<a class="sourceLine" id="cb15-15" data-line-number="15"></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="co"># Set up the model</span></a>
<a class="sourceLine" id="cb15-17" data-line-number="17">modspec &lt;-<span class="st"> </span><span class="kw">hydromad</span>(fuse_hydrological_timeseries,</a>
<a class="sourceLine" id="cb15-18" data-line-number="18">                    <span class="dt">sma =</span> <span class="st">"fusesma"</span>, </a>
<a class="sourceLine" id="cb15-19" data-line-number="19">                    <span class="dt">routing =</span> <span class="st">"fuserouting"</span>, </a>
<a class="sourceLine" id="cb15-20" data-line-number="20">                    <span class="dt">mid =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">1248</span>, </a>
<a class="sourceLine" id="cb15-21" data-line-number="21">                    <span class="dt">deltim =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb15-22" data-line-number="22"></a>
<a class="sourceLine" id="cb15-23" data-line-number="23"><span class="co"># Randomly generate 1 parameter set</span></a>
<a class="sourceLine" id="cb15-24" data-line-number="24">myNewParameterSet &lt;-<span class="st"> </span><span class="kw">parameterSets</span>(<span class="kw">coef</span>(modspec, <span class="dt">warn=</span><span class="ot">FALSE</span>),<span class="dv">1</span>,<span class="dt">method=</span><span class="st">"random"</span>)</a>
<a class="sourceLine" id="cb15-25" data-line-number="25"></a>
<a class="sourceLine" id="cb15-26" data-line-number="26"><span class="co"># Run a single simulation using the parameter set generated above</span></a>
<a class="sourceLine" id="cb15-27" data-line-number="27">modx &lt;-<span class="st"> </span><span class="kw">update</span>(modspec, <span class="dt">newpars =</span> myNewParameterSet)</a>
<a class="sourceLine" id="cb15-28" data-line-number="28"></a>
<a class="sourceLine" id="cb15-29" data-line-number="29"><span class="co"># Generate a summary of the result</span></a>
<a class="sourceLine" id="cb15-30" data-line-number="30"><span class="kw">summary</span>(modx)</a>
<a class="sourceLine" id="cb15-31" data-line-number="31"></a>
<a class="sourceLine" id="cb15-32" data-line-number="32"><span class="co"># The instantaneous runoff is</span></a>
<a class="sourceLine" id="cb15-33" data-line-number="33">U &lt;-<span class="st"> </span>modx<span class="op">$</span>U</a>
<a class="sourceLine" id="cb15-34" data-line-number="34"></a>
<a class="sourceLine" id="cb15-35" data-line-number="35"><span class="co"># The routed discharge is</span></a>
<a class="sourceLine" id="cb15-36" data-line-number="36">Qrout &lt;-<span class="st"> </span>modx<span class="op">$</span>fitted.values</a>
<a class="sourceLine" id="cb15-37" data-line-number="37"></a>
<a class="sourceLine" id="cb15-38" data-line-number="38"><span class="co"># Plot the Observed vs Simulated value</span></a>
<a class="sourceLine" id="cb15-39" data-line-number="39">hydromad<span class="op">:::</span><span class="kw">xyplot.hydromad</span>(modx)</a>
<a class="sourceLine" id="cb15-40" data-line-number="40"></a>
<a class="sourceLine" id="cb15-41" data-line-number="41"><span class="co"># Add the precipitation to the above plot</span></a>
<a class="sourceLine" id="cb15-42" data-line-number="42">hydromad<span class="op">:::</span><span class="kw">xyplot.hydromad</span>(modx, <span class="dt">with.P=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb15-43" data-line-number="43"></a>
<a class="sourceLine" id="cb15-44" data-line-number="44"><span class="co"># Calibrate FUSE using hydromad's fitBy method and the Shuffled Complex Evolution algorithm</span></a>
<a class="sourceLine" id="cb15-45" data-line-number="45">modfit &lt;-<span class="st"> </span><span class="kw">fitBySCE</span>(modspec)</a>
<a class="sourceLine" id="cb15-46" data-line-number="46"></a>
<a class="sourceLine" id="cb15-47" data-line-number="47"><span class="co"># Get a summary of the result</span></a>
<a class="sourceLine" id="cb15-48" data-line-number="48"><span class="kw">summary</span>(modfit)</a></code></pre></div>
<p>With hydromad is also possible to perform a thorough model assessment using basic statistics as well as summary plots. There is also a wide set of tools for calibration and a suite of other utility functions. The reader should refer to the official website and documentation for more details.</p>
</div>
<div id="other-packages-and-future-developments" class="section level1">
<h1 class="hasAnchor">
<a href="#other-packages-and-future-developments" class="anchor"></a>Other packages and future developments</h1>
<p>The fuse package could in future be submitted to CRAN and included in the Task View dedicated to Analysis of Ecological and Environmental Data (Envirometrics). This already includes a number of packages for hydrological modelling such as <a href="https://CRAN.R-project.org/package=topmodel">topmodel</a>, <a href="https://CRAN.R-project.org/package=dynatopmodel">dynatopmodel</a> and <a href="https://CRAN.R-project.org/package=wasim">wasim</a>. These packages only implement a single model structures,while fuse would complement them providing a framework for ensemble modelling. <a href="http://hydromad.catchment.org/">Hydromad</a> also implements ensemble modelling but it is not currently on CRAN.</p>
<p>A new version of the fuse Fortran code was recently released on <a href="https://github.com/naddor/fuse">GitHub</a>. Fortran users are advised to refer to this latest version of fuse. This package is not an interface for the latest Fortran code but any contribution in this direction is welcome.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#use-fuse-with-hydromad">Use fuse with hydromad</a></li>
      <li><a href="#other-packages-and-future-developments">Other packages and future developments</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Claudia Vitolo.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
